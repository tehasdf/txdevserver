<!doctype html>
<html>
<head>
    <title>pxl - logger</title>
    <script>
        var logTarget;
        var light;
        var queryTarget;
        var clear = false;

        var mes = function(data, category){
            if (typeof logTarget == "undefined"){
                return;
            }

            var newLog = document.createElement("li");
            if (typeof category != "undefined"){
                newLog.classList.add("event-" + category);
            };
            var addSpan = function(data, classname){
                var newSpan = document.createElement("span");
                newSpan.classList.add(classname);
                newSpan.innerHTML = data;
                newLog.appendChild(newSpan);
                return newSpan;
            }
            addSpan(new Date().toLocaleTimeString(), "now");
            addSpan(Math.round(data.time) + " ms", "time");
            var url = document.createElement("a");
            url.setAttribute("href", data.uri);
            url.setAttribute("target", "_blank");
            url.innerHTML = data.uri;
            addSpan("", "uri").appendChild(url);
            addSpan(data.code, "code");
            addSpan("Queries: " + data.queries, "queries");
            logTarget.insertBefore(newLog, logTarget.firstChild);

        };

        var mes_sql = function(query){
            if (typeof queryTarget == "undefined"){
                return;
            }
            if (clear){
                queryTarget.innerHTML = "";
            }
            var newLog = document.createElement("li");
            newLog.innerHTML = query;
            queryTarget.insertBefore(newLog, queryTarget.firstChild);
        };

        var mes_manual = function(message){
            if (typeof logTarget == "undefined"){
                return;
            }
            var newLog = document.createElement("li");
            var addSpan = function(data, classname){
                var newSpan = document.createElement("span");
                newSpan.classList.add(classname);
                newSpan.innerHTML = data;
                newLog.appendChild(newSpan);
                return newSpan;
            }
            
            addSpan(new Date().toLocaleTimeString(), "manual-now");
            addSpan(message, "manual");
            logTarget.insertBefore(newLog, logTarget.firstChild);
        };
        var ES = new EventSource("/log_es");

        ES.onmessage = function(data){
                message = JSON.parse(data.data);
                console.log(message.data);
                if (message.event == "hello"){
                    setConnected(true);
                    return;
                }
                if (message.event == "sql") {
                    mes_sql(message.data);
                    clear = false;
                    return;
                }
                if (message.event == "manual") {
                    mes_manual(message.data);
                    return;
                }
                mes(message.data, message.event);
                clear = true;
        };

        ES.onopen = function(){
            setConnected(true);
        };

        ES.onerror = function(){
            setConnected(false);
        };

        var setConnected = function(isConnected){
            if (typeof light == "undefined"){
                return;
            }

            if (isConnected){
                light.innerHTML = "Connected";
                light.classList.remove("off");
                light.classList.add("on");
            } else {
                light.innerHTML = "Not connected";
                light.classList.remove("on");
                light.classList.add("off");
            }
        };
        document.addEventListener('DOMContentLoaded', function(){
            logTarget = document.getElementById("log");
            light = document.getElementById("isConnected");
            queryTarget = document.getElementById("queryLog");
        });
        
        
    </script>

    <style>
    #log {
        list-style-type: none;
    }
    .event-hello {
        display: none;
    }

    #isConnected.on {
        color: green;
    }

    #isConnected.off {
        color: red;
    }
    #log li span {
        padding-right: 20px;
    }
    #log li {
        margin-bottom: 10px;
    }
    #log li.event-ERROR {
        color: red;
    }
    .manual {
        color: red;
        font-weight: bold;
    }
    #queryLog {
        color: #aaa;
        font-size: small;
    }
    </style>

</head>
<body>
    <span id="isConnected"></span>
    <ul id="log"></ul>
    <ul id="queryLog"></ul>
</body>
</html>
